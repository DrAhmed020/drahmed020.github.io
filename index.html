<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ملاحظات الطلاب</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // إعداد Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDEWffPfy-fljp32H8AjemraCau-f9JN-M",
            authDomain: "student-notes-app-3d196.firebaseapp.com",
            projectId: "student-notes-app-3d196",
            storageBucket: "student-notes-app-3d196.appspot.com",
            messagingSenderId: "99837564904",
            appId: "1:99837564904:web:6b880e2b80e439c8fcf65d",
            measurementId: "G-N63JWQNTZF"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // تعريف دالة الحذف في النطاق العام
        window.deleteNote = async function (id) {
            if (confirm("هل أنت متأكد من حذف هذه الملاحظة؟")) {
                try {
                    await deleteDoc(doc(db, "notes", id));
                    alert("تم حذف الملاحظة بنجاح!");
                    loadNotes(); // تحديث الملاحظات بعد الحذف
                } catch (error) {
                    console.error("خطأ أثناء الحذف:", error);
                    alert("حدث خطأ أثناء حذف الملاحظة.");
                }
            }
        };

        // دالة لتحميل الملاحظات
        async function loadNotes() {
            const notesContainer = document.getElementById("notesContainer");
            notesContainer.innerHTML = "جارٍ التحميل...";
            try {
                const querySnapshot = await getDocs(collection(db, "notes"));
                notesContainer.innerHTML = ""; // تنظيف الحاوية

                querySnapshot.forEach((doc) => {
                    const note = doc.data();
                    const noteItem = document.createElement("div");
                    noteItem.classList.add("note-item");
                    noteItem.innerHTML = `
                        <div>
                            <strong>${note.name}</strong> - ${note.grade}
                            <p>${note.note}</p>
                            ${note.image ? `<img src="${note.image}" alt="صورة">` : ""}
                            <button onclick="deleteNote('${doc.id}')">حذف</button>
                        </div>
                    `;
                    notesContainer.appendChild(noteItem);
                });
            } catch (error) {
                console.error("خطأ أثناء تحميل الملاحظات:", error);
                notesContainer.innerHTML = "حدث خطأ أثناء تحميل الملاحظات.";
            }
        }

        // دالة لإضافة ملاحظة جديدة
        async function addNoteToFirestore(name, grade, note, imageURL) {
            try {
                await addDoc(collection(db, "notes"), {
                    name,
                    grade,
                    note,
                    image: imageURL || null,
                    timestamp: Date.now()
                });
                alert("تمت إضافة الملاحظة بنجاح!");
                loadNotes(); // تحديث الملاحظات بعد الإضافة
            } catch (error) {
                console.error("خطأ أثناء الإضافة:", error);
                alert("حدث خطأ أثناء إضافة الملاحظة.");
            }
        }

        // التعامل مع إرسال النموذج
        document.getElementById("noteForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const name = document.getElementById("name").value;
            const grade = document.getElementById("grade").value;
            const note = document.getElementById("note").value;
            const imageInput = document.getElementById("image");
            let imageURL = null;

            if (imageInput.files.length > 0) {
                const file = imageInput.files[0];
                const reader = new FileReader();

                reader.onload = async (e) => {
                    imageURL = e.target.result;
                    await addNoteToFirestore(name, grade, note, imageURL);
                    document.getElementById("noteForm").reset();
                };

                reader.readAsDataURL(file);
            } else {
                await addNoteToFirestore(name, grade, note, imageURL);
                document.getElementById("noteForm").reset();
            }
        });

        // تحميل الملاحظات عند فتح الصفحة
        window.onload = loadNotes;
    </script>
</head>
<body>
    <div class="container">
        <h1>ملاحظات الطلاب</h1>
        <!-- زر عرض الملاحظات -->
        <a href="notes.html" style="text-decoration: none;">
            <button style="margin-bottom: 20px;">عرض ملاحظات الطلاب</button>
        </a>

        <!-- نموذج إضافة الملاحظات -->
        <form id="noteForm">
            <input type="text" id="name" placeholder="الاسم" required>
            <input type="text" id="grade" placeholder="المرحلة" required>
            <textarea id="note" placeholder="اكتب ملاحظتك هنا" required></textarea>
            <input type="file" id="image" accept="image/*">
            <button type="submit">إضافة الملاحظة</button>
        </form>

        <!-- عرض الملاحظات -->
        <div id="notesContainer" class="notes-container"></div>
    </div>
</body>
</html>
